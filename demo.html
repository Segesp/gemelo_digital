<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemelo Digital Chancay</title>
    <script src="https://unpkg.com/maplibre-gl@4.1.1/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@4.1.1/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
        }
        .header {
            padding: 12px;
            background: #ffffff;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .header h1 {
            margin: 0;
            color: #1e293b;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .controls {
            padding: 16px;
            background: #ffffff;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .control-group label {
            font-weight: 500;
            color: #374151;
        }
        .control-group select, .control-group input[type="checkbox"] {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
        }
        .stats-panel {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            padding: 12px;
            margin-left: auto;
            font-size: 14px;
        }
        .map-container {
            height: calc(100vh - 200px);
            position: relative;
        }
        .loading {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 1000;
        }
        .legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255,255,255,0.95);
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 12px;
            z-index: 1000;
        }
        .legend h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #1e293b;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 4px 0;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1px solid #fff;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
        }
        .footer {
            padding: 8px 16px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            font-size: 12px;
            color: #64748b;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üõ∞Ô∏è Gemelo Digital Chancay</h1>
    </div>
    
    <div class="controls">
        <div class="control-group">
            <label for="dataset">Dataset NASA:</label>
            <select id="dataset">
                <option value="">Cargando...</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="parameter">Par√°metro:</label>
            <select id="parameter">
                <option value="">Seleccione dataset primero</option>
            </select>
        </div>
        
        <div class="control-group">
            <input type="checkbox" id="showNASA">
            <label for="showNASA">Mostrar datos NASA</label>
        </div>
        
        <div class="control-group">
            <input type="checkbox" id="showPuerto" checked>
            <label for="showPuerto">Mostrar puerto</label>
        </div>
        
        <div class="stats-panel" id="statsPanel" style="display: none;">
            <strong>An√°lisis Espacial (24h):</strong>
            <span id="statsContent"></span>
        </div>
    </div>
    
    <div class="map-container">
        <div id="map"></div>
        <div class="loading" id="loading" style="display: none;">Cargando...</div>
        <div class="legend" id="legend" style="display: none;">
            <h4>Leyenda</h4>
            <div class="legend-item">
                <div class="legend-color" style="background: #3b82f6;"></div>
                <span>Valores bajos</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #eab308;"></div>
                <span>Valores medios</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ef4444;"></div>
                <span>Valores altos</span>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <span>üì° Datos en tiempo real de NASA, MODIS, VIIRS y sensores locales</span>
        <span>üîÑ Actualizaci√≥n autom√°tica</span>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let map;
        let datasets = [];
        let currentNASAData = [];
        
        // Initialize map
        function initMap() {
            map = new maplibregl.Map({
                container: 'map',
                style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
                center: [-77.27, -11.57],
                zoom: 12
            });
            
            map.on('load', () => {
                loadPuertoLayer();
                loadNASADatasets();
                startTemperatureUpdates();
            });
        }
        
        // Load puerto layer
        function loadPuertoLayer() {
            fetch(`${API_BASE}/features/puerto`)
                .then(r => r.json())
                .then(fc => {
                    map.addSource('puerto', { type: 'geojson', data: fc });
                    map.addLayer({
                        id: 'puerto-fill',
                        type: 'fill',
                        source: 'puerto',
                        paint: {
                            'fill-color': '#1d4ed8',
                            'fill-opacity': 0.3
                        }
                    });
                    map.addLayer({
                        id: 'puerto-line',
                        type: 'line',
                        source: 'puerto',
                        paint: {
                            'line-color': '#1d4ed8',
                            'line-width': 2
                        }
                    });
                })
                .catch(console.error);
        }
        
        // Load NASA datasets
        function loadNASADatasets() {
            showLoading(true);
            fetch(`${API_BASE}/nasa/datasets`)
                .then(r => r.json())
                .then(data => {
                    datasets = data;
                    populateDatasetSelect();
                    showLoading(false);
                })
                .catch(err => {
                    console.error('Error loading datasets:', err);
                    showLoading(false);
                });
        }
        
        // Populate dataset dropdown
        function populateDatasetSelect() {
            const datasetSelect = document.getElementById('dataset');
            datasetSelect.innerHTML = '<option value="">Seleccione dataset</option>';
            
            const uniqueDatasets = [...new Set(datasets.map(d => d.dataset))];
            uniqueDatasets.forEach(dataset => {
                const option = document.createElement('option');
                option.value = dataset;
                option.textContent = dataset;
                datasetSelect.appendChild(option);
            });
            
            if (uniqueDatasets.length > 0) {
                datasetSelect.value = uniqueDatasets[0];
                updateParameterSelect();
            }
        }
        
        // Update parameter dropdown based on selected dataset
        function updateParameterSelect() {
            const selectedDataset = document.getElementById('dataset').value;
            const parameterSelect = document.getElementById('parameter');
            
            parameterSelect.innerHTML = '<option value="">Seleccione par√°metro</option>';
            
            const parameters = datasets.filter(d => d.dataset === selectedDataset);
            parameters.forEach(item => {
                const option = document.createElement('option');
                option.value = item.parameter;
                option.textContent = `${item.parameter} (${item.count} puntos)`;
                parameterSelect.appendChild(option);
            });
            
            if (parameters.length > 0) {
                parameterSelect.value = parameters[0].parameter;
                loadNASAData();
            }
        }
        
        // Load NASA data for selected dataset/parameter
        function loadNASAData() {
            const dataset = document.getElementById('dataset').value;
            const parameter = document.getElementById('parameter').value;
            
            if (!dataset || !parameter) return;
            
            showLoading(true);
            
            // Load data points
            fetch(`${API_BASE}/nasa/data/${dataset}/${parameter}?limit=100&hours_back=24`)
                .then(r => r.json())
                .then(response => {
                    currentNASAData = response.data || [];
                    updateNASALayer();
                    showLoading(false);
                })
                .catch(err => {
                    console.error('Error loading NASA data:', err);
                    showLoading(false);
                });
            
            // Load spatial statistics
            fetch(`${API_BASE}/nasa/analysis/spatial-average/${dataset}/${parameter}?hours_back=24`)
                .then(r => r.json())
                .then(response => {
                    updateStatsPanel(response.spatial_stats);
                })
                .catch(console.error);
        }
        
        // Update NASA layer on map
        function updateNASALayer() {
            const showNASA = document.getElementById('showNASA').checked;
            
            // Remove existing NASA layer
            if (map.getSource('nasa-data')) {
                map.removeLayer('nasa-data-points');
                map.removeSource('nasa-data');
            }
            
            if (!showNASA || currentNASAData.length === 0) {
                document.getElementById('legend').style.display = 'none';
                return;
            }
            
            // Create GeoJSON from NASA data
            const geojson = {
                type: 'FeatureCollection',
                features: currentNASAData.map(point => ({
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [point.longitude, point.latitude]
                    },
                    properties: {
                        value: point.value,
                        timestamp: point.timestamp
                    }
                }))
            };
            
            // Add NASA data source and layer
            map.addSource('nasa-data', { type: 'geojson', data: geojson });
            
            map.addLayer({
                id: 'nasa-data-points',
                type: 'circle',
                source: 'nasa-data',
                paint: {
                    'circle-radius': [
                        'interpolate',
                        ['linear'],
                        ['get', 'value'],
                        0, 6,
                        50, 16
                    ],
                    'circle-color': [
                        'interpolate',
                        ['linear'],
                        ['get', 'value'],
                        0, '#3b82f6',
                        25, '#eab308',
                        40, '#ef4444'
                    ],
                    'circle-opacity': 0.8,
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#ffffff'
                }
            });
            
            // Add popup on click
            map.on('click', 'nasa-data-points', (e) => {
                const feature = e.features[0];
                const props = feature.properties;
                const dataset = document.getElementById('dataset').value;
                const parameter = document.getElementById('parameter').value;
                
                new maplibregl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML(`
                        <div style="padding: 8px; min-width: 200px;">
                            <strong>${dataset}</strong><br/>
                            <strong>${parameter}</strong><br/>
                            <hr style="margin: 8px 0;">
                            Valor: <strong>${props.value.toFixed(2)}</strong><br/>
                            Fecha: ${new Date(props.timestamp).toLocaleString('es-ES')}
                        </div>
                    `)
                    .addTo(map);
            });
            
            map.on('mouseenter', 'nasa-data-points', () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            
            map.on('mouseleave', 'nasa-data-points', () => {
                map.getCanvas().style.cursor = '';
            });
            
            document.getElementById('legend').style.display = 'block';
        }
        
        // Update statistics panel
        function updateStatsPanel(stats) {
            const panel = document.getElementById('statsPanel');
            const content = document.getElementById('statsContent');
            
            if (stats && stats.count > 0) {
                content.innerHTML = `
                    Promedio: ${stats.avg_value?.toFixed(2)} | 
                    Min: ${stats.min_value?.toFixed(2)} | 
                    Max: ${stats.max_value?.toFixed(2)} | 
                    Puntos: ${stats.count}
                `;
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }
        
        // Toggle puerto layer
        function togglePuertoLayer() {
            const show = document.getElementById('showPuerto').checked;
            const visibility = show ? 'visible' : 'none';
            
            if (map.getLayer('puerto-fill')) {
                map.setLayoutProperty('puerto-fill', 'visibility', visibility);
                map.setLayoutProperty('puerto-line', 'visibility', visibility);
            }
        }
        
        // Show/hide loading indicator
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        // Start temperature updates
        function startTemperatureUpdates() {
            updateTemperature();
            setInterval(updateTemperature, 30000); // Every 30 seconds
        }
        
        function updateTemperature() {
            fetch(`${API_BASE}/analysis/timeseries/harbor_temp/stats?start=${new Date(Date.now() - 3600*1000).toISOString()}`)
                .then(r => r.json())
                .then(s => {
                    const temp = s.avg !== null ? Math.round(s.avg * 100) / 100 : null;
                    document.querySelector('.header h1').innerHTML = 
                        `üõ∞Ô∏è Gemelo Digital Chancay <span style="margin-left: auto; color: #059669; font-size: 16px;">Temp puerto: ${temp || '...'} ¬∞C</span>`;
                })
                .catch(console.error);
        }
        
        // Event listeners
        document.getElementById('dataset').addEventListener('change', updateParameterSelect);
        document.getElementById('parameter').addEventListener('change', loadNASAData);
        document.getElementById('showNASA').addEventListener('change', updateNASALayer);
        document.getElementById('showPuerto').addEventListener('change', togglePuertoLayer);
        
        // Initialize
        initMap();
    </script>
</body>
</html>